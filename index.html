<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

  const SUPABASE_URL = 'https://tddxtsikzvpbqsxrxjok.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRkZHh0c2lrenZwYnFzeHJ4am9rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MTg5MzcyMDcsImV4cCI6MjAzNDUxMzIwN30.xX9q5RW4AaNgVt7jUCB8TAfgQnM8uP2uN92eA_1JdnA';
  const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

  let timers = [];

  async function fetchTimers() {
    const { data, error } = await supabase.from('timers').select('*').order('id');
    if (!error) {
      timers = data;
      if (timers.length === 0) await addNewTimer(); // Ø£ÙˆÙ„ Ù…Ø±Ø© ÙÙ‚Ø·
      timers.forEach((timer, index) => addTimerRow(timer, index));
      addSummaryRow();
    } else {
      console.error("Fetch error:", error);
    }
  }

  async function saveTimers() {
    await supabase.from('timers').delete().neq('id', 0);
    for (const t of timers) {
      await supabase.from('timers').insert({
        start: t.start || null,
        break: t.break || null
      });
    }
  }

  async function addNewTimer(startTime = null) {
    const newTimer = {};
    if (startTime) newTimer.start = startTime;
    timers.push(newTimer);
    await saveTimers();
    location.reload();
  }

  function format(date) {
    const d = new Date(date);
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, '0');
    const dd = String(d.getDate()).padStart(2, '0');
    const hh = String(d.getHours()).padStart(2, '0');
    const min = String(d.getMinutes()).padStart(2, '0');
    const ss = String(d.getSeconds()).padStart(2, '0');
    return `${yyyy}-${mm}-${dd} ${hh}:${min}:${ss}`;
  }

  function diffTime(start, end = new Date()) {
    const diff = new Date(end) - new Date(start);
    const totalSec = Math.floor(diff / 1000);
    const d = Math.floor(totalSec / (24 * 3600));
    const h = Math.floor((totalSec % (24 * 3600)) / 3600);
    const m = Math.floor((totalSec % 3600) / 60);
    const s = totalSec % 60;
    return `${d} ÙŠÙˆÙ… - ${h} Ø³Ø§Ø¹Ø© - ${m} Ø¯Ù‚ÙŠÙ‚Ø© - ${s} Ø«Ø§Ù†ÙŠØ©`;
  }

  async function addTimerRow(timer, index) {
    const table = document.getElementById("timersTable");
    const row = table.insertRow();

    // 1. ØªØ§Ø±ÙŠØ® Ø§Ù„Ù„Ø­Ø¸Ø©
    const cell1 = row.insertCell();
    if (timer.start) {
      cell1.textContent = format(timer.start);
    } else if (index === 0) {
      const btn = document.createElement("button");
      btn.textContent = "ØªØ§Ø±ÙŠØ® Ø§Ù„Ù„Ø­Ø¸Ø©";
      btn.className = "start-btn";
      btn.onclick = async () => {
        timer.start = new Date().toISOString();
        await saveTimers();
        location.reload();
      };
      cell1.appendChild(btn);
    } else {
      const previous = timers[index - 1];
      if (previous?.break) {
        timer.start = previous.break;
        await saveTimers();
        location.reload();
      } else {
        cell1.textContent = "Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ÙƒØ³Ø± Ø§Ù„Ø³Ø§Ø¨Ù‚...";
      }
    }

    // 2. Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ù…Ø³ØªÙ…Ø±Ø©
    const cell2 = row.insertCell();
    if (timer.start && !timer.break) {
      const span = document.createElement("span");
      span.id = "live_" + index;
      span.textContent = diffTime(timer.start);
      cell2.appendChild(span);
      setInterval(() => {
        span.textContent = diffTime(timer.start);
      }, 1000);
    } else if (timer.break) {
      cell2.textContent = diffTime(timer.start, timer.break);
    } else {
      cell2.textContent = "â€”";
    }

    // 3. Ø²Ø± Ø§Ù„ÙƒØ³Ø±
    const cell3 = row.insertCell();
    if (timer.start && !timer.break) {
      const btn = document.createElement("button");
      btn.textContent = "ØªÙ… Ø§Ù„ÙƒØ³Ø±";
      btn.className = "break-btn";
      btn.onclick = async () => {
        timer.break = new Date().toISOString();
        await saveTimers();
        await addNewTimer(timer.break);
        location.reload();
      };
      cell3.appendChild(btn);
    } else if (timer.break) {
      cell3.textContent = format(timer.break);
    } else {
      cell3.textContent = "â€”";
    }

    // 4. Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
    const cell4 = row.insertCell();
    if (timer.start && timer.break) {
      cell4.textContent = diffTime(timer.start, timer.break);
    } else {
      cell4.textContent = "â€”";
    }

    // 5. Ø²Ø± Ø§Ù„Ø­Ø°Ù
    const cell5 = row.insertCell();
    const delBtn = document.createElement("button");
    delBtn.textContent = "ğŸ—‘ Ø­Ø°Ù";
    delBtn.className = "delete-btn";
    delBtn.onclick = async () => {
      if (confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø­Ø°ÙØŸ")) {
        timers.splice(index, 1);
        await saveTimers();
        location.reload();
      }
    };
    cell5.appendChild(delBtn);
  }

  function addSummaryRow() {
    const table = document.getElementById("timersTable");
    const totalRow = table.insertRow();
    for (let i = 0; i < 4; i++) {
      const emptyCell = totalRow.insertCell();
      emptyCell.style.border = "none";
    }

    const countCell = totalRow.insertCell();
    countCell.style.fontWeight = "bold";
    countCell.style.textAlign = "center";
    countCell.style.backgroundColor = "#d4edda";
    countCell.style.color = "#155724";
    countCell.style.borderTop = "2px solid #28a745";
    countCell.style.borderBottom = "2px solid #28a745";
    countCell.textContent = "Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: " + timers.filter(t => t.break).length;
  }

  fetchTimers();
</script>
