<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…ØªØ±Ø§Ø¨Ø·Ø© Ù…Ø¹ Supabase</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 30px;
      background-color: #f5f5f5;
      direction: rtl;
    }
    h2 {
      color: #333;
    }
    table {
      width: 95%;
      margin: auto;
      border-collapse: collapse;
      background-color: #fff;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
    }
    th, td {
      border: 1px solid #ccc;
      padding: 10px;
    }
    th {
      background-color: #e9ecef;
    }
    button {
      padding: 6px 15px;
      border: none;
      border-radius: 5px;
      font-size: 14px;
      cursor: pointer;
    }
    .start-btn { background-color: #28a745; color: #fff; }
    .start-btn:hover { background-color: #218838; }
    .break-btn { background-color: #dc3545; color: #fff; }
    .break-btn:hover { background-color: #c82333; }
    .delete-btn { background-color: #6c757d; color: #fff; }
    .delete-btn:hover { background-color: #5a6268; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body>

  <h2>Ø³Ù„Ø³Ù„Ø© Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…ØªØ±Ø§Ø¨Ø·Ø© Ù…Ø¹ Supabase</h2>
  <table id="timersTable">
    <tr>
      <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù„Ø­Ø¸Ø©</th>
      <th>Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ù…Ø³ØªÙ…Ø±Ø©</th>
      <th>Ø²Ø± Ø§Ù„ÙƒØ³Ø±</th>
      <th>Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</th>
      <th>Ø­Ø°Ù</th>
    </tr>
  </table>

  <script>
    // Ø¨ÙŠØ§Ù†Ø§Øª Supabase: Ø¹Ø¯Ù‘Ù„ Ù‡Ù†Ø§ Ø¨Ø±Ø§Ø¨Ø·Ùƒ ÙˆÙ…ÙØªØ§Ø­Ùƒ
    const supabaseUrl = 'https://kqkuurzqkimpcfpfbipt.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtxa3V1cnpxa2ltcGNmcGZiaXB0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA0MzMyNzEsImV4cCI6MjA2NjAwOTI3MX0.WgBqh1AyBGLjNzzYAy6zKtD1o7M2AwBQRQeTz7OArZ4';
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    const user_code = "m123t";

    // ÙÙˆØ±Ù…Ø§Øª Ø§Ù„ØªØ§Ø±ÙŠØ®
    function format(date) {
      const d = new Date(date);
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const dd = String(d.getDate()).padStart(2, '0');
      const hh = String(d.getHours()).padStart(2, '0');
      const min = String(d.getMinutes()).padStart(2, '0');
      const ss = String(d.getSeconds()).padStart(2, '0');
      return `${yyyy}-${mm}-${dd} ${hh}:${min}:${ss}`;
    }

    // Ø­Ø³Ø§Ø¨ Ø§Ù„ÙØ±Ù‚ Ø§Ù„Ø²Ù…Ù†ÙŠ
    function diffTime(start, end = new Date()) {
      const diff = new Date(end) - new Date(start);
      if (diff < 0) return "0 Ø«Ø§Ù†ÙŠØ©";
      const totalSec = Math.floor(diff / 1000);
      const d = Math.floor(totalSec / (24 * 3600));
      const h = Math.floor((totalSec % (24 * 3600)) / 3600);
      const m = Math.floor((totalSec % 3600) / 60);
      const s = totalSec % 60;
      return `${d} ÙŠÙˆÙ… - ${h} Ø³Ø§Ø¹Ø© - ${m} Ø¯Ù‚ÙŠÙ‚Ø© - ${s} Ø«Ø§Ù†ÙŠØ©`;
    }

    // Ø¬Ù„Ø¨ ÙƒÙ„ Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ù† Supabase
    async function fetchTimers() {
      const { data, error } = await supabase
        .from('timers')
        .select('*')
        .eq('user_code', user_code)
        .order('start_time', { ascending: true });
      if (error) {
        alert("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: " + error.message);
        return [];
      }
      return data;
    }

    // Ø­Ø°Ù Ø¹Ø¯Ø§Ø¯
    async function deleteTimer(id) {
      if (!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¯Ø§Ø¯ØŸ")) return;
      const { error } = await supabase
        .from('timers')
        .delete()
        .eq('id', id);
      if (error) {
        alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù: " + error.message);
      } else {
        loadAndRender();
      }
    }

    // Ø¨Ø¯Ø¡ Ø¹Ø¯Ø§Ø¯ Ø¬Ø¯ÙŠØ¯ Ù…Ø±ØªØ¨Ø· Ø¨ÙˆÙ‚Øª Ø¨Ø¯Ø§ÙŠØ© Ù…Ø­Ø¯Ø¯
    async function addNewTimer(startTime = null) {
      const { data, error } = await supabase
        .from('timers')
        .insert([
          {
            user_code,
            title: 'Ø¹Ø¯Ø§Ø¯ Ø¬Ø¯ÙŠØ¯',
            start_time: startTime || new Date().toISOString(),
            end_time: null,
          }
        ]);
      if (error) {
        alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø¶Ø§ÙØ©: " + error.message);
      } else {
        loadAndRender();
      }
    }

    // ØªØ­Ø¯ÙŠØ« ÙˆÙ‚Øª Ø§Ù„ÙƒØ³Ø± (end_time)
    async function breakTimer(timer) {
      if (timer.end_time) return; // ØªÙ… Ø§Ù„ÙƒØ³Ø± Ù…Ø³Ø¨Ù‚Ù‹Ø§
      const { error } = await supabase
        .from('timers')
        .update({ end_time: new Date().toISOString() })
        .eq('id', timer.id);
      if (error) {
        alert("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒØ³Ø±: " + error.message);
      } else {
        // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ø¯Ø§Ø¯ Ø¬Ø¯ÙŠØ¯ ÙŠØ¨Ø¯Ø£ Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„ÙƒØ³Ø±
        await addNewTimer(timer.end_time);
      }
    }

    // Ø¨Ù†Ø§Ø¡ ØµÙÙˆÙ Ø§Ù„Ø¬Ø¯ÙˆÙ„
    function addTimerRow(timer) {
      const table = document.getElementById("timersTable");
      const row = table.insertRow();

      // ØªØ§Ø±ÙŠØ® Ø§Ù„Ù„Ø­Ø¸Ø©
      const cell1 = row.insertCell();
      cell1.textContent = timer.start_time ? format(timer.start_time) : "";

      // Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ù…Ø³ØªÙ…Ø±Ø© (ØªØªØ­Ø¯Ø« ÙƒÙ„ Ø«Ø§Ù†ÙŠØ© Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù„ÙƒØ³Ø±)
      const cell2 = row.insertCell();
      const spanDuration = document.createElement("span");
      cell2.appendChild(spanDuration);

      if (timer.start_time && !timer.end_time) {
        spanDuration.textContent = diffTime(timer.start_time);
        setInterval(() => {
          spanDuration.textContent = diffTime(timer.start_time);
        }, 1000);
      } else if (timer.start_time && timer.end_time) {
        spanDuration.textContent = diffTime(timer.start_time, timer.end_time);
      } else {
        spanDuration.textContent = "â€”";
      }

      // Ø²Ø± Ø§Ù„ÙƒØ³Ø±
      const cell3 = row.insertCell();
      if (timer.start_time && !timer.end_time) {
        const btnBreak = document.createElement("button");
        btnBreak.textContent = "ØªÙ… Ø§Ù„ÙƒØ³Ø±";
        btnBreak.className = "break-btn";
        btnBreak.onclick = async () => {
          await breakTimer(timer);
          loadAndRender();
        };
        cell3.appendChild(btnBreak);
      } else if (timer.end_time) {
        cell3.textContent = format(timer.end_time);
      } else {
        cell3.textContent = "â€”";
      }

      // Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
      const cell4 = row.insertCell();
      if (timer.start_time && timer.end_time) {
        cell4.textContent = diffTime(timer.start_time, timer.end_time);
      } else {
        cell4.textContent = "â€”";
      }

      // Ø­Ø°Ù
      const cell5 = row.insertCell();
      const delBtn = document.createElement("button");
      delBtn.textContent = "ğŸ—‘ Ø­Ø°Ù";
      delBtn.className = "delete-btn";
      delBtn.onclick = () => deleteTimer(timer.id);
      cell5.appendChild(delBtn);
    }

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ±Ø³Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„
    async function loadAndRender() {
      // Ø­Ø°Ù Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© (Ø¹Ø¯Ø§ Ø±Ø£Ø³ Ø§Ù„Ø¬Ø¯ÙˆÙ„)
      const table = document.getElementById("timersTable");
      while (table.rows.length > 1) {
        table.deleteRow(1);
      }
      const timers = await fetchTimers();

      // Ø¥Ø°Ø§ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ø¯Ø§Ø¯Ø§ØªØŒ Ù†Ø¶ÙŠÙ ÙˆØ§Ø­Ø¯ Ø¬Ø¯ÙŠØ¯ Ø¨Ø¯ÙˆÙ† Ø¨Ø¯Ø§ÙŠØ© Ù…Ø­Ø¯Ø¯Ø©
      if (timers.length === 0) {
        await addNewTimer();
        return;
      }

      // Ù†ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¶Ø§ÙØ© Ø¹Ø¯Ø§Ø¯ Ø¬Ø¯ÙŠØ¯ ÙŠØ¨Ø¯Ø£ Ø¨Ø¹Ø¯ ÙƒØ³Ø± Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø³Ø§Ø¨Ù‚
      for (let i = 0; i < timers.length; i++) {
        if (!timers[i].end_time) break; // Ù„Ù… ÙŠØªÙ… ÙƒØ³Ø± Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø¨Ø¹Ø¯ØŒ Ù„Ø§ Ù†Ø¶ÙŠÙ Ø¬Ø¯ÙŠØ¯
        if (i === timers.length -1) {
          // Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£Ø®ÙŠØ± Ù…ÙƒØ³ÙˆØ±ØŒ Ù†Ø¶ÙŠÙ Ø¹Ø¯Ø§Ø¯ Ø¬Ø¯ÙŠØ¯ ÙŠØ¨Ø¯Ø£ Ø¹Ù†Ø¯ ÙƒØ³Ø± Ø§Ù„Ø£Ø®ÙŠØ±
          await addNewTimer(timers[i].end_time);
        }
      }

      // Ø¹Ø±Ø¶ ÙƒÙ„ Ø¹Ø¯Ø§Ø¯ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„
      for (const timer of timers) {
        addTimerRow(timer);
      }

      // ØµÙ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹
      const totalRow = table.insertRow();
      for (let i = 0; i < 4; i++) {
        const emptyCell = totalRow.insertCell();
        emptyCell.style.border = "none";
      }
      const countCell = totalRow.insertCell();
      countCell.style.fontWeight = "bold";
      countCell.style.textAlign = "center";
      countCell.style.backgroundColor = "#d4edda";
      countCell.style.color = "#155724";
      countCell.style.borderTop = "2px solid #28a745";
      countCell.style.borderBottom = "2px solid #28a745";

      const brokenCount = timers.filter(t => t.end_time !== null).length;
      countCell.textContent = "Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: " + brokenCount;
    }

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
    loadAndRender();

  </script>

</body>
</html>
