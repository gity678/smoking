<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>عداد المدة المستمرة حتى الكسر</title>
  <style>
    body {
      font-family: Arial;
      direction: rtl;
      text-align: center;
      margin-top: 50px;
    }
    table {
      margin: auto;
      border-collapse: collapse;
      width: 95%;
    }
    th, td {
      border: 1px solid #999;
      padding: 15px;
      font-size: 16px;
    }
    button {
      padding: 7px 15px;
      font-size: 16px;
      margin: 5px;
    }
    .flex {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
    }
    #durationDisplay {
      font-weight: bold;
    }
  </style>
</head>
<body>

  <h2>عداد الزمن حتى لحظة الكسر</h2>

  <table>
    <tr>
      <th>تاريخ اللحظة</th>
      <th>المدة المستمرة (حيّة)</th>
      <th>زر الكسر</th>
      <th>المدة النهائية</th>
    </tr>
    <tr>
      <td id="startCell">
        <div class="flex" id="startContainer">
          <div id="startDate">—</div>
          <button onclick="startCounting()" id="startBtn">تاريخ اللحظة</button>
        </div>
      </td>
      <td id="durationDisplay">—</td>
      <td id="breakCell">—</td>
      <td id="finalDuration">—</td>
    </tr>
  </table>

  <script>
    let startTime = null;
    let timerInterval = null;
    let broken = false;

    function formatTime(date) {
      const yyyy = date.getFullYear();
      const mm = String(date.getMonth() + 1).padStart(2, '0');
      const dd = String(date.getDate()).padStart(2, '0');
      const hh = String(date.getHours()).padStart(2, '0');
      const min = String(date.getMinutes()).padStart(2, '0');
      const ss = String(date.getSeconds()).padStart(2, '0');
      return `${yyyy}-${mm}-${dd} ${hh}:${min}:${ss}`;
    }

    function startCounting() {
      startTime = new Date();
      localStorage.setItem("startTime", startTime.toISOString());
      localStorage.setItem("isBroken", "false");
      broken = false;

      document.getElementById("startDate").textContent = formatTime(startTime);
      const btn = document.getElementById("startBtn");
      if (btn) btn.remove();

      document.getElementById("breakCell").innerHTML = '<button onclick="breakNow()">تم الكسر</button>';

      runTimer();
    }

    function runTimer() {
      if (!startTime || broken) return;

      if (timerInterval) clearInterval(timerInterval);

      timerInterval = setInterval(() => {
        const now = new Date();
        const diffMs = now - startTime;
        const totalSeconds = Math.floor(diffMs / 1000);
        const days = Math.floor(totalSeconds / (24 * 3600));
        const hours = Math.floor((totalSeconds % (24 * 3600)) / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;

        document.getElementById("durationDisplay").textContent =
          `${days} يوم - ${hours} ساعة - ${minutes} دقيقة - ${seconds} ثانية`;
      }, 1000);
    }

    function breakNow() {
      if (!startTime || broken) return;
      broken = true;
      clearInterval(timerInterval);

      const breakTime = new Date();
      const diffMs = breakTime - startTime;
      const totalSeconds = Math.floor(diffMs / 1000);
      const days = Math.floor(totalSeconds / (24 * 3600));
      const hours = Math.floor((totalSeconds % (24 * 3600)) / 3600);
      const minutes = Math.floor((totalSeconds % 3600) / 60);
      const seconds = totalSeconds % 60;

      document.getElementById("breakCell").textContent = formatTime(breakTime);
      document.getElementById("finalDuration").textContent =
        `${days} يوم - ${hours} ساعة - ${minutes} دقيقة - ${seconds} ثانية`;

      localStorage.setItem("isBroken", "true");
      localStorage.setItem("breakTime", breakTime.toISOString());
    }

    window.onload = () => {
      const savedStart = localStorage.getItem("startTime");
      const isBroken = localStorage.getItem("isBroken") === "true";

      if (savedStart) {
        startTime = new Date(savedStart);
        broken = isBroken;
        document.getElementById("startDate").textContent = formatTime(startTime);

        const btn = document.getElementById("startBtn");
        if (btn) btn.remove();

        if (!broken) {
          document.getElementById("breakCell").innerHTML = '<button onclick="breakNow()">تم الكسر</button>';
          runTimer();
        } else {
          const breakTime = new Date(localStorage.getItem("breakTime"));
          const diffMs = breakTime - startTime;
          const totalSeconds = Math.floor(diffMs / 1000);
          const days = Math.floor(totalSeconds / (24 * 3600));
          const hours = Math.floor((totalSeconds % (24 * 3600)) / 3600);
          const minutes = Math.floor((totalSeconds % 3600) / 60);
          const seconds = totalSeconds % 60;

          document.getElementById("breakCell").textContent = formatTime(breakTime);
          document.getElementById("finalDuration").textContent =
            `${days} يوم - ${hours} ساعة - ${minutes} دقيقة - ${seconds} ثانية`;
        }
      }
    };
  </script>

</body>
</html>
